# build de novo repeat library by RepeatModeler (v 2.0.4) and RepeatMasker (v 4.1.5) with RepBase_20181026 and Dfam_3.7
BuildDatabase -name Cni_p Cni.v2.hic.chr.fasta
RepeatModeler -database Cni_p -LTRStruct -threads 20

# identify unknown TEs with DeepTE
grep "#LTR/Unknown" consensi.fa.classified  | sed 's/>//' | seqtk subseq consensi.fa.classified - >LTR_unknown.fa
grep -v "#LTR/Unknown" consensi.fa.classified  | sed 's/>//' | seqtk subseq consensi.fa.classified - >LTR_known.fa
DeepTE.py -i LTR_unknown.fa -fam LTR -sp M -m_dir ~/node3/database/Metazoans_model > DeepTE.log 2>&1
sed 's/LTR\/Unknown__ClassI_LTR_Copia/LTR\/Copia/' opt_DeepTE.fasta | sed 's/LTR\/Unknown__ClassI_LTR_Gypsy/LTR\/Gypsy/'|sed 's/LTR\/Unknown__ClassI_LTR/LTR\/Unknown/' >LTR_unknown_DeepTE.fa
grep "#Unknown" LTR_known.fa  | sed 's/>//' | seqtk subseq consensi.fa.classified - >unknown.fa
grep -v "#Unknown" LTR_known.fa  | sed 's/>//' | seqtk subseq consensi.fa.classified - >known.fa
DeepTE.py -i unknown.fa -sp M -m_dir ~/node3/database/Metazoans_model > DeepTE.log 2>&1
sed 's/Unknown__ClassI_//g' opt_DeepTE.fasta | sed 's/Unknown__ClassII_//g' | sed 's/Unknown__ClassIII_//g' | sed 's/__unknown//g' | sed 's/Unknown_.*/Unknown/g' | sed 's/_/\//2' > unknown_DeepTE.fa
cat known.fa unknown_DeepTE.fa LTR_unknown_DeepTE.fa > repeatmodeler.lib.fa

# build TE library with EDTA (v 2.0.1)
EDTA.pl --genome Cni.v2.hic.chr.fasta --species others --u 0.2e-8 --sensitive 0 --anno 0 --force 1 --threads 20

# identify unknown TEs with DeepTE
grep "#LTR/unknown" Cni.v2.hic.chr.fasta.mod.EDTA.TElib.fa  | sed 's/>//' | seqtk subseq Cni.v2.hic.chr.fasta.mod.EDTA.TElib.fa - >LTR_unknown.fa
grep -v "#LTR/unknown" Cni.v2.hic.chr.fasta.mod.EDTA.TElib.fa  | sed 's/>//' | seqtk subseq Cni.v2.hic.chr.fasta.mod.EDTA.TElib.fa - >LTR_known.fa
DeepTE.py -i LTR_unknown.fa -fam LTR -sp M -m_dir ~/node3/database/Metazoans_model > DeepTE.log 2>&1
sed 's/LTR\/unknown__ClassI_LTR_Copia/LTR\/Copia/' opt_DeepTE.fasta | sed 's/LTR\/unknown__ClassI_LTR_Gypsy/LTR\/Gypsy/'|sed 's/LTR\/unknown__ClassI_LTR/LTR\/unknown/' >LTR_unknown_DeepTE.fa
cat LTR_unknown_DeepTE.fa LTR_known.fa > EDTA.lib.fa
grep -v "Helitron" EDTA.lib.fa | sed 's/>//' | seqtk subseq EDTA.lib.fa - > EDTA.no_Helitron.lib.fa

# merge and remove redundancy of TE libraries from EDTA and RepeatModeler
famdb.py -i RepeatMaskerLib.h5 families -f fasta_acc -a -d  --include-class-in-name Crassostrea > Crassostrea.Repbase.repeat.fa
cat repeatmodeler.lib.fa EDTA.no_Helitron.lib.fa Crassostrea.Repbase.repeat.fa > Cni.p.all.lib.fa 
cd-hit-est -i Cni.p.all.lib.fa -o Cni.p.all_cdhit.lib.fa -n 10 -d 0 -M 4000 -T 10

# identify repeat elements with RepeatMasker
RepeatMasker -lib Cni.p.all_cdhit.lib.fa -a -no_is -gff -xsmall -pa 10 Cni.v2.hic.chr.fasta
